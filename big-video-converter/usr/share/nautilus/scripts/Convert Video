#!/bin/bash

# Nautilus Script for Big Video Converter
# File: /usr/share/nautilus/scripts/Convert Video

# Check if any files were selected
if [ -z "$NAUTILUS_SCRIPT_SELECTED_FILE_PATHS" ]; then
    # Fallback: use current directory if no files selected
    if [ -n "$NAUTILUS_SCRIPT_CURRENT_URI" ]; then
        # Convert URI to path
        CURRENT_PATH=$(echo "$NAUTILUS_SCRIPT_CURRENT_URI" | sed 's|^file://||' | python3 -c "import sys, urllib.parse; print(urllib.parse.unquote(sys.stdin.read().strip()))")
        exec big-video-converter-gui "$CURRENT_PATH"
    else
        exec big-video-converter-gui
    fi
else
    # Convert the newline-separated paths to an array
    IFS=$'\n' read -d '' -r -a selected_files <<< "$NAUTILUS_SCRIPT_SELECTED_FILE_PATHS"
    
    # Filter only video files
    video_files=()
    for file in "${selected_files[@]}"; do
        # Check if file is a video based on extension
        case "${file,,}" in
            *.mp4|*.mkv|*.webm|*.mov|*.avi|*.wmv|*.mpeg|*.mpg|*.m4v|*.ts|*.flv)
                video_files+=("$file")
                ;;
        esac
    done
    
    # Launch with video files or all selected files if no video files found
    if [ ${#video_files[@]} -gt 0 ]; then
        exec big-video-converter-gui "${video_files[@]}"
    else
        exec big-video-converter-gui "${selected_files[@]}"
    fi
fi
